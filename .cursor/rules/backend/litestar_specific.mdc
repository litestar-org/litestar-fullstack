---
description:
globs:
alwaysApply: false
---
# Litestar Framework Conventions (with msgspec)

## Objective
To ensure consistent and effective use of Litestar features, promoting maintainability, performance, and adherence to Litestar best practices, with **`msgspec.Struct` as the mandatory data structure for API DTOs**.

## Context
- **Technologies**: Litestar, Python 3.13+, `msgspec`.
- **Key Concepts**: Controllers, Routers, `msgspec.Struct` for DTOs, Dependency Injection, Guards, Middleware, Event Handlers, Lifespan Hooks, Plugins (especially for Advanced Alchemy).
- **Project Files**: `src/py/app/server/`, `src/py/app/lib/` (for dependencies, exceptions, plugins), `src/py/app/schemas/` (for `msgspec.Struct` definitions), `src/py/app/asgi.py` (app factory).

## Rules

### Application Structure
- **App Factory Pattern**: Utilize the app factory pattern (e.g., `create_app()` in `src/py/app/asgi.py`) for application instantiation.
- **Plugin Usage**: Leverage Litestar plugins for integrating extensions like SQLAlchemy (via Advanced Alchemy `SQLAlchemyPlugin`), SAQ, Vite, etc. Configure plugins centrally.

### Controllers and Routes
- **Organization**: Group related endpoints into `Controller` classes within `src/py/app/server/api/`.
- **Path Naming**: Use `kebab-case` for URL paths.
- **DTOs with `msgspec.Struct`**: **Mandatory**: Use `msgspec.Struct` for all request bodies and response data DTOs. Define these in `src/py/app/schemas/`.
    - Litestar provides automatic validation of incoming `msgspec.Struct` data and serialization of outgoing `msgspec.Struct` data.
    - âœ…
      ```python
      from litestar import post, get
      from litestar.controller import Controller
      from app.schemas import UserCreate, UserRead # msgspec.Struct definitions
      from app.services import UserService
      from uuid import UUID

      class UserController(Controller):
          path = "/users"
          tags = ["Users"]
          # Ensure UserService is injected, e.g. via __init__ or Provide in dependencies
          # def __init__(self, user_service: UserService) -> None:
          #     self.user_service = user_service

          @post()
          async def create_user(self, data: UserCreate, user_service: UserService) -> UserRead:
              # 'data' is an auto-validated instance of UserCreate (msgspec.Struct)
              created_db_user = await user_service.create(data) # Service handles mapping to DB model
              # Map DB model back to UserRead msgspec.Struct for response
              return UserRead(
                  id=created_db_user.id,
                  email=created_db_user.email,
                  name=created_db_user.name,
                  is_active=created_db_user.is_active,
                  created_at=created_db_user.created_at,
                  updated_at=created_db_user.updated_at,
              )

          @get("/{user_id:uuid}")
          async def get_user_by_id(self, user_id: UUID, user_service: UserService) -> UserRead:
              db_user = await user_service.get(user_id)
              return UserRead(
                  id=db_user.id,
                  email=db_user.email,
                  # ... other fields
              )
      ```
- **Async Endpoints**: Prefer `async def` for route handlers.

### Dependency Injection (`Dependency`)
- **Explicit Dependencies**: Use Litestar's DI for resources like DB sessions, services, configs.
- **Service Layer Injection**: Inject service classes (e.g., `UserService`) into controllers.
    - Services themselves will obtain the `AsyncSession` via DI to initialize repositories (see `advanced_alchemy_integration.mdc`).

### Error Handling
- **Litestar Exceptions**: Utilize Litestar's built-in exceptions (`HTTPException`, `NotFoundException`, `ValidationException`).
- **Custom Exception Handlers**: Implement for application-specific errors.

### Guards and Middleware
- **Guards**: For route/controller authorization.
- **Middleware**: For cross-cutting concerns (logging, CORS).

### OpenAPI Schema
- **Docstrings**: Provide clear docstrings for controllers/handlers for OpenAPI generation.
- **Tags**: Use `tags` for grouping.
- `msgspec.Struct` definitions will be automatically used by Litestar to generate the OpenAPI schema components.

## Exceptions
- Websocket handlers have different data handling patterns.
- CLI commands are outside the Litestar request-response cycle.
