# Critical Fixes for Inertia-SPA Parity

## Date: 2025-12-29
## Status: Research Complete

---

## 1. Schema Naming Conventions

### Problem
The SPA implementation uses `Response` and `Request` suffixes on schema names, which deviates from the Inertia reference implementation pattern. Schema names should describe what they represent, not their HTTP direction.

### Reference (Inertia - CORRECT)
From `/home/cody/code/litestar/litestar-fullstack-inertia/app/domain/accounts/schemas/`:

```python
__all__ = (
    "MfaBackupCodes",      # NOT MfaBackupCodesResponse
    "MfaChallenge",        # NOT MfaChallengeRequest
    "MfaConfirm",          # NOT MfaConfirmRequest
    "MfaDisable",          # NOT MfaDisableRequest
    "MfaSetup",            # NOT MfaSetupResponse
    "EmailSent",           # NOT EmailSentResponse
    "PasswordReset",       # NOT ResetPasswordRequest
    "PasswordResetToken",  # NOT ValidateResetTokenResponse
)
```

### Current SPA (WRONG)
From `/home/cody/code/litestar/litestar-fullstack-spa/src/py/app/domain/accounts/schemas/`:

| Current Name | Should Be | Notes |
|--------------|-----------|-------|
| `MfaSetupResponse` | `MfaSetup` | Contains secret, QR code, URI |
| `MfaConfirmRequest` | `MfaConfirm` | Contains 6-digit code |
| `MfaBackupCodesResponse` | `MfaBackupCodes` | Contains backup codes list |
| `MfaDisableRequest` | `MfaDisable` | Contains password |
| `MfaChallengeRequest` | `MfaChallenge` | Contains code or recovery_code |
| `MfaChallengeResponse` | `MfaVerifyResult` | Contains verification result (optional) |
| `MfaStatusResponse` | `MfaStatus` | Contains enabled, confirmed_at, remaining codes |
| `TokenRefreshResponse` | `TokenRefresh` | Contains message |
| `ForgotPasswordResponse` | `PasswordResetSent` | Contains message and expiry |
| `ResetPasswordResponse` | `PasswordResetComplete` | Contains message and user_id |
| `ValidateResetTokenResponse` | `ResetTokenValidation` | Contains valid, user_id, expires_at |
| `SessionsResponse` | `SessionList` | Contains sessions and count |
| `OAuthAuthorizationResponse` | `OAuthAuthorization` | Contains auth URL and state |
| `LoginResponse` | Remove | Inertia doesn't have this, login returns OAuth2Login directly |

### Migration Impact
- All controller return types need updating
- TypeScript generated types will change
- Frontend API hooks will need updating
- OpenAPI spec will change

---

## 2. Deferred Security Groups

### Status: ALREADY CORRECT ✅

The SPA User model already implements the correct deferred loading pattern matching Inertia.

### Inertia Pattern
From `/home/cody/code/litestar/litestar-fullstack-inertia/app/db/models/user.py`:

```python
hashed_password: Mapped[str | None] = mapped_column(
    String(length=255), nullable=True, default=None,
    deferred=True,
    deferred_group="security_sensitive",
)
totp_secret: Mapped[str | None] = mapped_column(
    EncryptedString(key=settings.app.SECRET_KEY),
    nullable=True, default=None,
    deferred=True,
    deferred_group="security_sensitive",
)
backup_codes: Mapped[list | None] = mapped_column(
    JSONB, nullable=True, default=None,
    deferred=True,
    deferred_group="security_sensitive",
)
```

### SPA Implementation (CORRECT)
From `/home/cody/code/litestar/litestar-fullstack-spa/src/py/app/db/models/_user.py`:

```python
hashed_password: Mapped[str | None] = mapped_column(
    String(length=255), nullable=True, default=None,
    deferred=True,
    deferred_group="security_sensitive",
)
totp_secret: Mapped[str | None] = mapped_column(
    EncryptedString(key=settings.app.SECRET_KEY),
    nullable=True, default=None,
    deferred=True,
    deferred_group="security_sensitive",
)
backup_codes: Mapped[list | None] = mapped_column(
    JSONB, nullable=True, default=None,
    deferred=True,
    deferred_group="security_sensitive",
)
```

### Using Deferred Groups
When loading sensitive data, use `undefer_group("security_sensitive")`:

```python
from sqlalchemy.orm import undefer_group

# In service or repository
user = await self.repository.get_one(
    id=user_id,
    load=[undefer_group("security_sensitive")],
)
```

---

## 3. Zod Generation

### Current State
The Zod schemas at `/home/cody/code/litestar/litestar-fullstack-spa/src/js/src/lib/generated/api/zod.gen.ts` are auto-generated by `@hey-api/openapi-ts` from the OpenAPI spec.

### Problem
The auto-generated Zod schemas have several issues:
1. They mirror the backend schema naming (with Response/Request suffixes)
2. They may not have optimal validation rules
3. Complex union types like `z.union([z.string(), z.null()]).optional()` are verbose

### Solution
1. **Keep generated Zod schemas** - They come from OpenAPI and ensure type safety
2. **Create custom form validation schemas** - For complex frontend forms
3. **Use manual helpers for specific validations** - Email, password, etc.

### Custom Validation Helpers (to create)
Create `/home/cody/code/litestar/litestar-fullstack-spa/src/js/src/lib/validation.ts`:

```typescript
import { z } from "zod";

// Password validation matching backend requirements
export const passwordSchema = z
  .string()
  .min(8, "Password must be at least 8 characters")
  .max(100, "Password must be less than 100 characters")
  .regex(/[A-Z]/, "Password must contain at least one uppercase letter")
  .regex(/[a-z]/, "Password must contain at least one lowercase letter")
  .regex(/[0-9]/, "Password must contain at least one number");

// Email validation
export const emailSchema = z
  .string()
  .email("Invalid email address")
  .max(255, "Email must be less than 255 characters");

// TOTP code validation
export const totpCodeSchema = z
  .string()
  .length(6, "Code must be 6 digits")
  .regex(/^\d+$/, "Code must contain only numbers");

// Backup/recovery code validation
export const recoveryCodeSchema = z
  .string()
  .length(8, "Recovery code must be 8 characters")
  .regex(/^[A-F0-9]+$/i, "Invalid recovery code format");

// Username validation
export const usernameSchema = z
  .string()
  .min(3, "Username must be at least 3 characters")
  .max(30, "Username must be less than 30 characters")
  .regex(/^[a-zA-Z0-9_-]+$/, "Username can only contain letters, numbers, underscores and hyphens");

// Form schemas
export const loginFormSchema = z.object({
  email: emailSchema,
  password: z.string().min(1, "Password is required"),
});

export const registerFormSchema = z.object({
  email: emailSchema,
  password: passwordSchema,
  passwordConfirm: z.string(),
  name: z.string().min(1, "Name is required").optional(),
}).refine((data) => data.password === data.passwordConfirm, {
  message: "Passwords don't match",
  path: ["passwordConfirm"],
});

export const mfaSetupFormSchema = z.object({
  code: totpCodeSchema,
});

export const mfaChallengeFormSchema = z.union([
  z.object({ code: totpCodeSchema, recoveryCode: z.never().optional() }),
  z.object({ code: z.never().optional(), recoveryCode: recoveryCodeSchema }),
]);
```

---

## 4. React Email Templates

### Current State
The SPA project uses React Email templates in `src/js/templates/`, compiled to static HTML in `src/py/app/server/static/email/`.

### Reference Implementation
The Accelerator project has React email templates at:
`/home/cody/code/g/dma/accelerator/src/js/templates/`

### Build Script Pattern
From `/home/cody/code/g/dma/accelerator/src/js/templates/build-emails.ts`:

```typescript
import { renderToStaticMarkup } from "react-dom/server";
import { createElement } from "react";
import { readdirSync, writeFileSync, mkdirSync, existsSync } from "fs";
import { join, basename } from "path";

const EMAILS_DIR = join(__dirname, "src/emails");
const OUTPUT_DIR = join(__dirname, "../../py/app/server/static/email");

async function buildTemplates() {
  if (!existsSync(OUTPUT_DIR)) {
    mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  const templateFiles = readdirSync(EMAILS_DIR).filter((f) => f.endsWith(".tsx"));

  for (const file of templateFiles) {
    const modulePath = join(EMAILS_DIR, file);
    const outputName = basename(file, ".tsx") + ".html";
    const outputPath = join(OUTPUT_DIR, outputName);

    const module = await import(modulePath);
    const Component = module.default;

    const html = "<!DOCTYPE html>\n" + renderToStaticMarkup(createElement(Component));

    writeFileSync(outputPath, html, "utf-8");
    console.log(`Built: ${outputName}`);
  }
}

buildTemplates().catch(console.error);
```

### Template Structure
Email templates use placeholder syntax `{{VARIABLE_NAME}}` that gets replaced at runtime:

```tsx
// email-verification.tsx
export default function EmailVerification() {
  return (
    <Layout title="Verify Your Email - {{APP_NAME}}">
      <Header appName="{{APP_NAME}}" />
      <div style={{ padding: "32px" }}>
        <h2>Verify your email address</h2>
        <p>Hi {"{{USER_NAME}}"},</p>
        <p>Click the button below to verify your email:</p>
        <Button href="{{VERIFICATION_URL}}">Verify Email Address</Button>
        <p>Or copy this link: {"{{VERIFICATION_URL}}"}</p>
        <p>This link expires in {"{{EXPIRY_HOURS}}"} hours.</p>
      </div>
      <Footer appName="{{APP_NAME}}" />
    </Layout>
  );
}
```

### Implementation Plan
1. Create email template directory: `src/js/templates/src/emails/`
2. Create shared components: `Layout.tsx`, `Header.tsx`, `Footer.tsx`, `Button.tsx`
3. Create email templates:
   - `email-verification.tsx`
   - `password-reset.tsx`
   - `password-reset-confirmation.tsx`
   - `welcome.tsx`
   - `team-invitation.tsx`
4. Create build script: `src/js/templates/build-emails.ts`
5. Add npm script: `"build:emails": "bun run src/templates/build-emails.ts"`
6. Update Makefile to include email build step

---

## 5. Advanced Alchemy Patterns

### Service Provider Pattern
Both implementations use `create_service_provider` from Advanced Alchemy:

```python
from advanced_alchemy.extensions.litestar.providers import create_service_provider

provide_users_service = create_service_provider(
    UserService,
    load=[
        selectinload(User.roles).options(joinedload(UserRole.role, innerjoin=True)),
        selectinload(User.oauth_accounts),
        selectinload(User.teams).options(
            joinedload(TeamMember.team, innerjoin=True).options(load_only(Team.name, Team.slug)),
        ),
    ],
    error_messages={
        "integrity": "User operation failed due to integrity violation.",
        "not_found": "User not found.",
        "duplicate_key": "A user with this identifier already exists.",
    },
)
```

### Service Hooks
The SPA correctly implements the `to_model_on_*` hooks:

```python
class UserService(SQLAlchemyAsyncRepositoryService[User]):
    async def to_model_on_create(self, data: ModelDictT[User]) -> ModelDictT[User]:
        return await self._populate_model(data)

    async def to_model_on_update(self, data: ModelDictT[User]) -> ModelDictT[User]:
        return await self._populate_model(data)

    async def to_model_on_upsert(self, data: ModelDictT[User]) -> ModelDictT[User]:
        return await self._populate_model(data)
```

### Filter Patterns
Use `create_filter_dependencies` for standardized filtering:

```python
from advanced_alchemy.extensions.litestar.providers import create_filter_dependencies

filter_dependencies = create_filter_dependencies(
    id_filter=True,
    search_filter=True,
    created_at_filter=True,
    updated_at_filter=True,
    order_by_filter=True,
)
```

---

## Summary of Required Changes

### Must Fix (Backend)
1. **Schema Naming** - Rename all `*Response` and `*Request` schemas
   - 14+ schemas need renaming
   - Update all controller return type annotations
   - Update signature_namespace in routes

### Must Fix (Frontend)
2. **Validation Helpers** - Create manual Zod schemas for forms
   - Create `src/js/src/lib/validation.ts`
   - Use for form validation instead of generated schemas

3. **React Email Templates** - Set up email template system
   - Create template directory structure
   - Port shared components from accelerator
   - Create build script

### Already Correct (No Change Needed)
- ✅ Deferred security groups on User model
- ✅ Advanced Alchemy service hooks (`to_model_on_*`)
- ✅ Service provider pattern with eager loading
- ✅ Inner repository pattern in services

### Out of Scope
- Zod generation from OpenAPI - Keep as-is (generated from spec)
